#!/usr/bin/env node

const MQTT = require('mqtt')
const mqtt = MQTT.connect(process.env.MQTT_CNNSTRING)
const ping = `${process.env.ROOT_TOPIC}/health/test`
const pong = `${process.env.ROOT_TOPIC}/health/heartbeat`
const timeout = 10 * 1000

mqtt.on('connect', () => {
  console.log('connected to mqtt')
  // Send a PING and wait for a PONG
  mqtt.subscribe(pong)
  mqtt.publish(ping, `r u alive, ${process.env.BOTNAME}?`)
})
mqtt.on('message', (topic, message) => {
  // On PONG, exit with 0 to indicate good health
  console.log('found a heartbeat <3')
  mqtt.end(() => process.exit(0))
})

// If the wait is too long, health is bad; exit with code 1
setTimeout(() => {
  console.log(`no heartbeat for ${timeout} ms </3`)
  mqtt.end(() => process.exit(1))
  setTimeout(() => process.exit(1), 1000)
}, timeout)
