#!/usr/bin/env node

const MQTT = require('mqtt')
const prompt = require('prompt')
const mqtt = MQTT.connect(process.env.MQTT_CNNSTRING)
const rootTopic = process.env.ROOT_TOPIC

mqtt.on('connect', function () {
  console.log(`Connected to mqtt server`)
  console.log(`Publish a message under topic ${rootTopic}`)
  prompt.start()
  prompt.get({
    properties: {
      topic: {
        pattern: /^[a-zA-Z\-/]+$/,
        message: 'Invalid input. Check regex.',
        required: true,
        default: 'health/test'
      },
      message: {
        pattern: /^[-+a-zA-Z\s/]+$/,
        message: 'Invalid input. Check regex.',
        required: true,
        default: 'r u there?'
      }
    }
  }, function (err, result) {
    if (err) {
      console.error(err)
      return
    }
    mqtt.publish(`${rootTopic}/${result.topic}`, result.message)
    console.log(`${rootTopic}/${result.topic} -> ${result.message}`)

    mqtt.end(() => process.exit(0))
  })
})
